#!/usr/bin/env php
<?php

$GLOBALS['THRIFT_ROOT'] = './thrift/lib/Thrift';

require_once('thrift/src/Thrift.php');

require_once($GLOBALS['THRIFT_ROOT'].'/Type/TMessageType.php');
require_once($GLOBALS['THRIFT_ROOT'].'/Type/TType.php');
require_once($GLOBALS['THRIFT_ROOT'].'/Exception/TException.php');
require_once($GLOBALS['THRIFT_ROOT'].'/Factory/TStringFuncFactory.php');
require_once($GLOBALS['THRIFT_ROOT'].'/StringFunc/TStringFunc.php');
require_once($GLOBALS['THRIFT_ROOT'].'/StringFunc/Core.php');
require_once($GLOBALS['THRIFT_ROOT'].'/Transport/TSocket.php');
require_once($GLOBALS['THRIFT_ROOT'].'/Transport/TBufferedTransport.php');
require_once($GLOBALS['THRIFT_ROOT'].'/Protocol/TBinaryProtocol.php');

require_once('Hbase.php');
require_once('Types.php');

use Thrift\Transport\TSocket;
use Thrift\Transport\TBufferedTransport;
use Thrift\Protocol\TBinaryProtocol;
use Hbase\HbaseClient;
use Hbase\Mutation;
use Hbase\TScan;

$table = 'note';

$fp = @fopen('users.txt', 'r');
if (!$fp) exit;

// $mongos = new MongoClient('"mongodb://localhost'); // XXX: 바꿀곳. mongos 떠있는곳.
// $mongod = new MongoClient('"mongodb://localhost'); // XXX: 바꿀곳. db0,db1,db2 replica sets
$mongos = new MongoClient('mongodb://web3'); // XXX: 바꿀곳. mongos 떠있는곳.
$mongod = new MongoClient('mongodb://db0,db1,db2', array('replicaSet' => 'som')); // XXX: 바꿀곳. db0,db1,db2 replica sets

$socket = new TSocket('localhost', 9090); // XXX: 바꿀곳
$socket->setSendTimeout(30000); // Ten seconds (too long for production, but this is just a demo ;)
$socket->setRecvTimeout(60000); // Twenty seconds
$transport = new TBufferedTransport( $socket );
$protocol = new TBinaryProtocol( $transport );
$client = new HbaseClient( $protocol );

$transport->open();

$cnt = 1;
$k = 1;
while (!feof($fp))
{
    $user_id = trim(fgets($fp, 64));
    if (strlen($user_id) != 24) continue;

    $cur_rev = get_rev($user_id); // 현재 리비전 번호
    if ($cur_rev === false) continue;
    $cur_rev = $cur_rev - 301;
    $cur_rev = $cur_rev < 1 ? 0 : $cur_rev;

    try {

        $where = array('user_id' => $user_id, 'r' => array('$gt' => $cur_rev));
        $cursor = $mongos->note->rev->find($where)->sort(array('r' => -1));

        // 50000에서 하나씩 내린다.
        // 마이그레이션 종료 후 모든 사용자의 리비전 번호는 50000 이 된다.
        // HBase에는 r:0999950000 이렇게 들어감.
        $no = 50000;

        foreach ($cursor as $rev) {
            if (!isset($rev['_id']) || empty($rev['_id'])) continue;
            if (!isset($rev['user_id']) || empty($rev['user_id'])) continue;
            if (!isset($rev['r']) || empty($rev['r'])) continue;

            $family = 'r:'.column($no); $no--;

            unset($rev['_id']); unset($rev['user_id']); unset($rev['r']);

            $row = array(new mutation(array('column' => $family,
                                            'value' => json_encode($rev))));
            $client->mutaterow($table, $user_id, $row, null);
            $k++;
        }

    } catch (TException $e) {
        print 'TException: '.$e->__toString().' Error: '.$e->getMessage()."\n";
        continue;
    }

    // update_rev($user_id); // XXX: 다시복구

    echo $cnt.': '.$user_id."\n";
    $cnt++;
}



fclose($fp);
$transport->close();
$mongod->close(true);
$mongos->close(true);
echo "\n\nDone!!! (".$k.")\n\n";
exit;


function update_rev($user_id)
{
    global $mongod;

    $where = array('_id' => new MongoId($user_id));
    $set   = array('$set' => array('r' => 50000));
    $opts  = array('upsert' => true, 'multiple' => false);
    $mongod->revno_note->rev_no->update($where, $set, $opts);
}

function get_rev($user_id)
{
    global $mongos;
    global $mongod;

    $where = array('_id' => new MongoId($user_id));
    $cursor = $mongod->revno_note->rev_no->find($where)->limit(1);
    if ($cursor->count(true) > 0) {
        $row = $cursor->getNext();
        return $row['r'];
    }

    $where  = array('user_id' => $user_id);
    $fields = array('r' => 1);
    $cursor = $this->mongos->note->rev->find($where)->sort(array('r' => -1))->limit(1); // r를 내림차순으로
    if ($cursor->count(true) < 1) {
        return false;
    }
    $row = $cursor->getNext();
    return $row['r'];
}

function column($r)
{
    $r = 1000000000 - $r;
    return str_pad($r, 10, '0', STR_PAD_LEFT);
}
